---
title: "R Notebook"
output: html_notebook
---

#load data
Photoperiod data:
- species
- photoperiodism: photoperiod sensitivity requirements(ad, id, ld, sd, ldsd, lsd, sd, sld, yes (exists in unknown form), na)
- cultivar: if present, cultivar name
- reference: source of information
- notes: additional notes on photoperiod sensitivity
- sensitivity_yn: binary variable of whether photoperiod sensitivity in any form exists in species

Flowering time data:
- species
- year: year of record
- doy: day of year
- source: source of information

```{r}
library(tidyverse)
library(ggplot2) #for graphs

pp <- read.csv("./Data/appendix1.csv") #read in photoperiod data
pp$species <- gsub("_", " ",pp$species)

pp <- pp %>% 
  group_by(species)%>% #for each location*year*species combination,
  slice(which.min(doy))  #find first flowering each degree cell

ft <- read.csv("./data/appendix2.csv") #read completed flowering time data

df <- left_join(ft, pp, by = "species")
rm(pp)
rm(ft)

```

#remove data without long, short or no daylenth requirement. This is mostly because they have multiple requirements in a specific order.

```{r}
df$simple_photoperiodism <- as.factor(df$simple_photoperiodism) #make it a factor
df$simple_photoperiodism <- relevel(df$simple_photoperiodism, "na") #relevel so na is the reference factor

df_final <- df %>%
  filter(simple_photoperiodism != "other") #filter
```

#a quick summary of our data
```{r}
summary(df_final)
```


#map data
```{r}
library(sf) #for applying graphs to spatial data (simple version of sp)
library(rgeos) #for gCentroid()
library(rworldmap) #for getMap()
library(rworldxtra) #for higher resolution map

map_base <- ggplot() + #specify map base
  borders("world", colour="gray50", fill="gray50")

map_pp <- map_base + #use map base
  geom_jitter(data = df_final, aes(x = lon, y = lat, colour = simple_photoperiodism), size = 0.05, alpha = 0.1, shape = 1) +#layer points on map
  xlim(-125, 45)+ #set x limits based on summary
  ylim(20, 65)+#set y limits based on summary
  guides(colour = guide_legend(override.aes = list(size = 1, alpha = 1))) #override the transparency and size to make legend readable

map_pp

```
#Analyse data

```{r}
library(tidyverse)
library(lme4)
library(lmerTest)

#lm_basic <- lmer(doy ~ sensitivity_yn*year + (1|species), data = df) #original model with species and binary sensitivity

#lm_groups <- lmer(doy ~ simple_photoperiodism*year + (1|species), data = df) #improved model with species and groups of sensitivity

#lm_latitude <- lmer(doy ~ sensitivity_yn*year + (1|species) + lat, data = df) #improved model as above with latitude as fixed effect

lm_final <- lmer(doy ~ simple_photoperiodism*year + (1|species) + lat, data = df_final)#improved model with all aspects of previous models with 'other' group removed

lm_comparison <- lmer(doy ~ year + (1|species) + lat, data = df_final) #comparison model to lm_final with photoperiodism removed as variable

```

#check assumptions of model
```{r}
qqnorm(resid(lm_final)) #qqplot
qqline(resid(lm_final)) #add line

hist(resid(lm_final), breaks = 25) #look at normality of residuals
```
The qq plot seems heavy tailed at the start but after looking at the histogram, the proportion of samples in the tail is very small compared to the main section, which fits pretty well. 

#Comparing our final model with the others
To determine whether photoperiod information improves our flowering time model, let's see compare the pair
```{r}
AIC(lm_final) #compare the pair
AIC(lm_comparison)

anova(lm_final, lm_comparison) #compare the pair statistically
```
The AICs on their own suggest that photoperiod does improve the model, and the ANOVA shows that this improvement is significant!

#Comparing our final models through bootstrapping
```{r}
library(pbkrtest)

bootstrap <- PBmodcomp(lm_final, lm_comparison, nsim = 599) #bootstrap comparison
bootstrap
```
So now we've confirmed that photoperiodism ihas an effect on flowering time. 
Let's look at the details

#Look at what our model tells us
```{r}
summary(lm_final) #look at our model
```
We have a lot of variable to unpack, so remembering that no photoperiodism is the baseline for when sd or ld is mentioned:
- both long day and short day plants historically flowered earlier than others
- both long day and short day plants are flowering later with each passing year
- long day plants are falling behind by 2.0 days per decade
- short day plants are falling behind by 6.4 days per decade, almost a week!

Less important observations:
- plants in general are advancing at 2.4 days per decade
- plants in general flower 1.5 days later for every degree they are away from the equator

#look at each photoperiod group seperately in case it helps
```{r}
lm_na <- lmer(doy ~ year + (1|species) + lat, data = df_final, subset = simple_photoperiodism == "na")

lm_sd <- lmer(doy ~ year + (1|species) + lat, data = df_final, subset = simple_photoperiodism == "sd")

lm_ld <- lmer(doy ~ year + (1|species) + lat, data = df_final, subset = simple_photoperiodism == "ld")

summary(lm_na)
summary(lm_sd)
summary(lm_ld)
```
These trends seem to be pretty consistent with our initial results.

The one difference is that in the long-day plants, year does not have a significant effect on flowering time. However, it is very close and our main analysis (that gives the model more information about the additional effects) says the effect exists, so we can conclude that the effect is small but significant. 

#plot graph
```{r}
ggplot.photogroups <- 
  ggplot(subset(df_final))+
  geom_point(aes(y = doy, x = year, colour = simple_photoperiodism), size = 1, alpha = 0.2)+
  xlab("Year")+
  ylim(-4, 366)+
  xlim(1950, 2017)+
  ylab("Average First Flowering Day")+
  guides(color = guide_legend(title = "Photoperiod Sensitivity", reverse = TRUE))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15, face  = "bold"))

ggplot.photogroups
```

