---
title: "Photoperiod Project R Notebook"
output: html_notebook
---

Load Packages and Base data

#Mypalette:
- a colour palette to make the graph colours consistent

#Photoperiod data:
- species
- photoperiodism: photoperiod sensitivity requirements(ad, id, ld, sd, ldsd, lsd, sd, sld, yes (exists in unknown form), na)
- cultivar: if present, cultivar name
- reference: source of information
- notes: additional notes on photoperiod sensitivity
- sensitivity_yn: binary variable of whether photoperiod sensitivity in any form exists in species

#Flowering time data:
- species
- year: year of record
- doy: day of year
- source: source of information

```{r}
library(tidyverse)

mypalette <- c("#0072B2","#E69F00")

pp <- read.csv("./Data/appendix1.csv") #read in photoperiod data

ft <- read.csv("./Data/appendix2.csv") #read in flowering data
```

Combine Photoperiod and Annual Average Flowering Day of Year data

Combined photoperiod and flowering time data columns:
- species
- doy: average first flowering day of a species each year
- year
- source: source of record

```{r}

source("./R/joinFloweringData.R")

data <- joinFloweringData(pp, ft) #adding flowering time info to photoperiod sensitivity info as well as applying limits
```


Effect of Photoperiod Sensitivity on First Flowering Date over time analysis:
- mixed effect generalised linear model
- photoperiod sensitive vs photoperiod insensitive
- lmer function in the lme4 package
- obtained P-values using the lmerTest package

Analyse data

```{r include=FALSE}

write.csv(data, "./graphdata.csv") #write combined data as csv

source("./R/getPhotoFFD.R")

Photo.FFD.Results <- getPhotoFFD(data) #Analyse data

```

Optional: Check Assumptions
results for linear models
-Residuals for linear models
-QQplots for linear models
-AIC for linear models
-Results for ANOVAs

```{r}
summary(Photo.FFD.Results$lm_interaction)
Photo.FFD.Results$residuals_interaction
Photo.FFD.Results$qq_interaction
Photo.FFD.Results$aic_interaction
Photo.FFD.Results$anova

summary(Photo.FFD.Results$lm_t)
summary(Photo.FFD.Results$lm_f)
```

The Results

Photoperiod sensitive plants are flowering later than photoperiod insensitive plants
- Significant effect of photoperiod sensitivity 

```{r}
summary(Photo.FFD.Results$lm_interaction)
Photo.FFD.Results$photo_plot #show plot
```

Evidence for different first flowering between photoperiod sensitive and photoperiod insensitive species
- Effect of photoperiod sensitivity on first flowering significant (p=0.00733)**

Evidence rates of change between photoperiod sensitive and photoperiod insensitive species
- Interaction between photoperiod sensitive and insensitive species is significant (p<0.00713)**

```{r}
summary(Photo.FFD.Results$lm_interaction)
```

Additional Analysis
- Because we had different sample sizes for photoperiod sensitive v photoperiod insensitive groups, we could not compare the variances of the two groups
- Thus, an ANOVA could not be peformed
- However, by performing bootstrapping analysis we can figure out which model fits the data more closely




##
- We can however compare means of the two groups

- So we fitted linear models to the combined dataset including both photoperiod sensitive and insensitive species to identify whether it made a significant difference over time and to each species, extracting the gradient of the line to find their individual rates of advancement.

- The resulting graph shows that there is no difference between photoperiod sensitive and photoperiod insensitive species.
#add line to show n of samples for each treatment group

```{r}
source("./R/getPhotoAdditional.R")

Photo.Additional.Results <- getPhotoAdditional(data)

Photo.Additional.Results$data_models_output #show modelled changes in FFD for each species
Photo.Additional.Results$data_models_ttest
Photo.Additional.Results$box_plot #show plot

```
##

Comparing the occurence of photoperiod sensitivity with other traits

Get photoperiodism data
- Remove parts not needed for analysis

Get Life History and Growth Form Data
- Life history data (annual/perennial) from the TRY plant database  
- Growth form data (woody/herbaceous) was adapted from Zanne et al. (2009). 
- Species that could not be readily classified in to these groups were excluded from the relevant analyses

#Only works half the time?

```{r}
traits_data <- transmute(pp, species = species, photoperiodism = photoperiodism, photoperiod_sensitive = sensitivity_yn)

source("./R/addLHGF.R")

traits_data <- addLHGF(traits_data) #takes tibble, and adds columns for life history and growth form
```


```{r}
source("./R/piechart.R")
```

Analyse Life History
```{r}
life_history <- traits_data %>% #Tally life histories
  filter(!is.na(life))%>%
  group_by(photoperiod_sensitive, life) %>%
  tally()

life_history

life_history_chi <- chisq.test(life_history$n, p = c(0.25, 0.25, 0.25, 0.25)) #Perform chi-square test

life_history_chi
life_history_chi$residuals
```

 and Growth Form Data
 
```{r}
woodiness <- traits_data %>%
  filter(!is.na(woodiness), woodiness != "variable")%>% #remove NAs and variable woodiness
  group_by(photoperiod_sensitive, woodiness) %>%
  tally()

woodiness

woodiness_chi <- chisq.test(woodiness$n, p = c(0.25, 0.25, 0.25, 0.25))
woodiness_chi
woodiness_chi$residuals
```

Phylogentic Analysis
- Combine the photoperiod sensitivity data with the phylogenetic data using used the phylosignal package
- pruning the phylogenetic tree published by Zanne et al. (2014) using the ape package
- Phylogenetic signal and the significance of the signal was calculated using phylo.d from the caper package to:
  - find Frits and Purvis D 

```{r}
data <- pp

source("./R/getPhylo.R")

Photo.Phylo.Results <- getPhylo(data)
```


Finally, we performed chi-squared tests comparing photoperiod sensitivity with life history and woodiness using the chisq.test command from base R (R Core Team, 2017).

```{r}
source("getChisqGFLH.R")

Photo.GFLH.Results <- getChisqGFLH(data)
```

```{r}
Photo.FFD.Results$plot


ggplot(data, aes(y=doy, x=year, colour = photoperiod_sensitive))+
  geom_point()


Photo.Phylo.Results

Photo.GFLH.Results

```

##Additional analyses

#load and read in everything needed
```{r}
pp <- read.csv("./Data/appendix1.csv") #read in photoperiod data
data <- read.csv("./graphdata.csv") #read in dataset

library(tidyverse)
library(ggplot2)

```


#repeat lm analyses
```{r}
require(lme4)
require(lmerTest)

lm.photogroups <- lmer(doy ~ simple_photoperiodism*year + (1|species), data = data2)

summary(lm.photogroups)
anova(lm.photogroups) #significant

plot.photogroups <- plot(lm.photogroups) #check assumptions
qqnorm.photogroups <- qqnorm(resid(lm.photogroups))
  qqline(resid(lm.photogroups))


```

```{r}

ggplot.photogroups <- 
  ggplot(data2)+
  geom_point(aes(y=doy, year, colour = simple_photoperiodism), size = 2, alpha = 0.4)+ 
  geom_smooth(aes(y=doy, year, colour = simple_photoperiodism), method = "lm", se=F, size = 2) + #trendline
  xlab("Year")+
  ylim(0, 400)+
  xlim(1950, 2017)+
  ylab("Average First Flowering Day")+
  guides(color = guide_legend(title = "Photoperiod Sensitivity", reverse = TRUE))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15, face  = "bold"))
```

Other seems to be a combination of primarily ld and sd, so let's exclude it to properly look at the difference between ld and sd

#analyse each group
```{r}
lm.photogroups <- lmer(doy ~ simple_photoperiodism*year + (1|species), data = data2)

summary(lm.photogroups)

plot.photogroups <- plot(lm.photogroups) #check assumptions
qqnorm.photogroups <- qqnorm(resid(lm.photogroups))
  qqline(resid(lm.photogroups))
aic.photogroups <- AIC(lm.photogroups)

ggplot.photogroups <- 
  ggplot(data2)+
  geom_point(aes(y=doy, year, colour = simple_photoperiodism), size = 2, alpha = 0.4)+ 
  geom_smooth(aes(y=doy, year, colour = simple_photoperiodism), method = "lm", se=F, size = 2) + #trendline
  xlab("Year")+
  ylim(0, 400)+
  xlim(1950, 2017)+
  ylab("Average First Flowering Day")+
  guides(color = guide_legend(title = "Photoperiod Sensitivity", reverse = TRUE))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15, face  = "bold"))+
  facet_grid(simple_photoperiodism ~ .)


```

#add trendline for each group
```{r}
lm.sd <- lmer(doy ~ year + (1|species_source), data = data2_nooutlier, subset = simple_photoperiodism == "sd")

lm.ld <- lmer(doy ~ year + (1|species), data = data2, subset = simple_photoperiodism == "ld")

lm.na <- lmer(doy ~ year + (1|species), data = data2, subset = simple_photoperiodism == "na")

#summary(lm.sd)
#summary(lm.ld)
#summary(lm.na)
```

#Looking at each species

```{r}
#Make a nice graph
ggplot.photogroups.species <- 
  ggplot(data2)+
  geom_smooth(aes(y=doy, year, colour = species), method = "lm", se=F, size = 2) + #trendline
  xlab("Year")+
  ylim(0, 400)+
  xlim(1950, 2017)+
  ylab("Average First Flowering Day")+
  guides(color = guide_legend(title = "Photoperiod Sensitivity", reverse = TRUE))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15, face  = "bold"),
        legend.position = "none")+
  facet_grid(simple_photoperiodism ~ .)

#Figure out what this odd outlier species is?

data2$simple_photoperiodism <- as.character(data2$simple_photoperiodism) #make sure models report actual simple_photoperiodism and not just factor level

data_Models2 <- data2 %>% #Make a model for each species
    group_by(species) %>%
    do(Model = lm( doy ~ year, data = .),
       simple_photoperiodism = first(.$simple_photoperiodism))
  
  data_Models2_output <- data_Models2 %>% # Take gradient and intercept for easy reading
    rowwise() %>%
    mutate(year.effect = coef(Model)[2], intercept = coef(Model)[1])  %>% 
    select(-Model)
```

Poa pratensis is a huge outlier, let's check it out.

From looking at data2 it looks like poa pratensis being in both uknc and rmbl datasets could be problematic.

We can fix this by testing each species*source combination as a random effect instead of just species...

#Looking at each species*source group

```{r}
data2$species_source <- paste(data2$species, data2$source, sep="_") #create species_source combinations
  
#Make a nice graph
ggplot.photogroups.species_source <- 
  ggplot(data2)+
  geom_smooth(aes(y=doy, year, colour = species_source), method = "lm", se=F, size = 2) + #trendline
  xlab("Year")+
  ylim(0, 400)+
  xlim(1950, 2017)+
  ylab("Average First Flowering Day")+
  guides(color = guide_legend(title = "Photoperiod Sensitivity", reverse = TRUE))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15, face  = "bold"),
        legend.position = "none")+
  facet_grid(simple_photoperiodism ~ .)

```

Let's redo the main analysis with species*source instead of just species

```{r}
lm.photogroups.species_source <- lmer(doy ~ simple_photoperiodism*year + (1|species_source), data = data2) #create linear model

summary(lm.photogroups.species_source) #look at output
anova(lm.photogroups.species_source)


plot.photogroups.species_source <- plot(lm.photogroups.species_source) #check assumptions
qqnorm.photogroups.species_source <- qqnorm(resid(lm.photogroups.species_source))
  qqline(resid(lm.photogroups.species_source))
aic.photogroups.species_source <- AIC(lm.photogroups.species_source)

```
The results are no longer significant. The aic is better though, so this model fits the data more closely at least.

##Requested graphs
#ld
```{r}
ld <- data2 %>% filter(simple_photoperiodism == "ld")

ggplot.ld <- ggplot(ld)+ #ld points+model
  geom_point(aes(y=doy, year, colour = species), size = 2, alpha = 0.4)+ 
  geom_smooth(aes(y=doy, year), method = "lm", se=F, size = 2) + #trendline
  xlab("Year")+
  ylim(0, 400)+
  xlim(1950, 2017)+
  ylab("Average First Flowering Day")+
  guides(color = guide_legend(title = "Photoperiod Sensitivity", reverse = TRUE))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15, face  = "bold"),
        legend.position = "none")
rm(ld)
ggplot.ld
```

#sd
```{r}
#sd points+model
sd <- data2_nooutlier %>% filter(simple_photoperiodism == "sd")

ggplot.sd <- ggplot(sd)+ #ld points+model
  geom_point(aes(y=doy, year, colour = species), size = 2, alpha = 0.4)+ 
  geom_smooth(aes(y=doy, year), method = "lm", se=F, size = 2) + #trendline
  xlab("Year")+
  ylim(0, 400)+
  xlim(1950, 2017)+
  ylab("Average First Flowering Day")+
  guides(color = guide_legend(title = "Photoperiod Sensitivity", reverse = TRUE))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15, face  = "bold"),
        legend.position = "none")
rm(sd)
ggplot.sd
```

#original lm
```{r}
data2 <- read.csv("./Data/data2.csv")

lm.photogroups<- lmer(doy ~ simple_photoperiodism*year + (1|species), data = data2) #create linear model

summary(lm.photogroups) #look at output
anova(lm.photogroups)

```

#repeat lm analyses without outlier
```{r}
data2_nooutlier <- data2 %>% filter(species != "Poa_pratensis")

lm.photogroups.nooutlier <- lmer(doy ~ simple_photoperiodism*year + (1|species), data = data2_nooutlier)

summary(lm.photogroups.nooutlier)
anova(lm.photogroups.nooutlier)

```

#repeat lm analyses with only ld and sd
```{r}
data2_ldsd <- data2 %>% filter(simple_photoperiodism != "na")

lm.photogroups.ldsd <- lmer(doy ~ simple_photoperiodism*year + (1|species), data = data2_ldsd)

summary(lm.photogroups.ldsd)
anova(lm.photogroups.ldsd)

```

#repeat lm analyses without outlier or na
```{r}
data2_ldsd_nooutlier <- data2_nooutlier %>% filter(simple_photoperiodism != "na")

lm.photogroups.ldsd.noooutlier <- lmer(doy ~ simple_photoperiodism*year + (1|species), data = data2_ldsd_nooutlier)

summary(lm.photogroups.ldsd.noooutlier)
anova(lm.photogroups.ldsd.noooutlier)

```

