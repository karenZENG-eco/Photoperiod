---
title: "Photoperiod NXT"
output: html_notebook
---
Rewrite of photoepriod analysis but on a per-species basis.

```{r warning=FALSE}
library(tidyverse)
library(lme4) #for general linear model stuff
library(nlme) #mixed effect models
library(broom) #for do function

library(ggplot2) #graphs :)

library(ape) #general tree
library(geiger) #phylo.aov and phylANOVA
library(phytools) #phylANOVA

```

#Get datasets
```{r}
pp <- read.csv("./Data/appendix1.csv") #read in photoperiod data

pp <- pp %>% 
  group_by(species)%>% #for each species
  slice(which.min(order))  #find most accurate photoperiod record

ft <- read.csv("./data/appendix2.csv") #read completed flowering time data

df <- left_join(ft, pp, by = "species") #join the two datasets

temp <- df %>% group_by(species) %>% count()

pp <- left_join(pp, temp, by = "species")#add number of flowering time records available per species

rm(ft)
rm(temp)
```


```{r}
species_summary <- df %>% 
  group_by(species) %>% #for each species repeat analysis
  do({ summ <- summary(lm(doy ~ year + lat, .)) #make linear model and take a summary
       summarize(.,intercept = summ[["coefficients"]][1], #take only the numbers we are interested in from each lm
                 intercept_p = summ[["coefficients"]][10], #ie what are the effects of each variable
                 year_effect = summ[["coefficients"]][2],  #and how certain we are of each (p-val)
                 year_p = summ[["coefficients"]][11],
                 lat_effect = summ[["coefficients"]][3],
                 lat_p = summ[["coefficients"]][12])}) %>% ungroup() #ungroup to put it all in one table


species_summary <- left_join(species_summary, pp[, c(1, 7, 9)], by = "species") #put the photoperiod info back in

species_summary$significant_yn <- 0
species_summary$significant_yn[species_summary$intercept_p <= 0.05] <- 1
species_summary$significant_yn <- as.logical(species_summary$significant_yn)

species_summary_confident <- species_summary #set all records that are not significant to zero
species_summary_confident$intercept[species_summary$intercept_p > 0.05] = 0
species_summary_confident$year_effect[species_summary$year_p > 0.05] = 0
species_summary_confident$lat_effect[species_summary$lat_p > 0.05] = 0
```

ggplot
```{r}
species_summary_confident_summary <- species_summary_confident %>% 
  group_by(simple_photoperiodism) %>% #for each type of photoperiod
  filter(!is.na(year_effect)) %>%
  summarise(mean = weighted.mean(x = year_effect, w = log(n)), #what is the average change throughout the years? (weighted by log of number of records)
            n = n()) #how many species are a part of this trend
ggplot(data = species_summary_confident_summary) + geom_col(aes(x = simple_photoperiodism, y = mean)) + ggtitle("weighted average flowering time change per photoperiod type")

temp <- species_summary_confident %>% filter(!is.na(year_effect))
ggplot(data = species_summary, aes(x = simple_photoperiodism, y = year_effect)) + geom_point(aes(alpha = 0.5, size = n, colour = significant_yn))

```

#summary
Results will greatly change based on n weighting method but I think log is reasonable.
A lot of data is lost in this analysis
But we can correct for phylogeny at last.

That year effect = -6 datapoint is sunflowers. It only has 5 points so a bit sus.
Can look into in further sometime.

#Prepare tree things
```{r}
tree <- read.tree("./data/ALLMB.txt") #read in tree

species_summary$species <- gsub(" ", "_", species_summary$species)#change species name to fit phylo trees

tree <- drop.tip(tree, tree$tip.label[-na.omit(match(species_summary$species, tree$tip.label))]) #trim tree to our species for ease of use

species_summary$matchtree <- match(species_summary$species, tree$tip.label)
species_summary<- species_summary[is.na(species_summary$matchtree) == F,] #trim species list to tree

row.names(species_summary) <- species_summary$species #set row names as species so namecheck works
namecheck <- name.check(phy = tree, data = species_summary) #check between tree and rownames of species summary which should be the species names now 

#make it so order of dataframe matches order of tree
species_summary <- species_summary%>%arrange(match(species_summary$species, tree$tip.label))
```

#Make a new dataframe and tree with only significant trends for year effect and use it to trim a new tree
```{r}
species_summary_confident <- as.data.frame(species_summary[species_summary$significant_yn == T,]) #remove nonsignificant results and turn it from a tibble to a dataframe

tree_confident <- drop.tip(tree, tree$tip.label[-na.omit(match(species_summary_confident$species, tree$tip.label))]) #trim tree again

tree_confident$node.label[tree_confident$node.label == ""] <- which(tree_confident$node.label == "") #label unnamed nodes based on node number

row.names(species_summary_confident)<- species_summary_confident$species #makes species names the row names again for combining the dataframes
```

##Perform one way ANOVA between simple photoperiodism groups with only data from significant regression lines
```{r}
simple_photoperiodism_vector <- species_summary_confident$simple_photoperiodism
year_effect_vector <- species_summary_confident$year_effect

aov_species_summary_confident <- phylANOVA(tree = tree_confident, x = simple_photoperiodism_vector, y = year_effect_vector, nsim = 9999, posthoc = TRUE)
```

#Make a new dataframe and tree with all regression lines and use it to trim a new tree
```{r}
species_summary_finite <- as.data.frame(species_summary[is.finite(species_summary$year_effect),]) #remove non-finite results (na, nan and NULL) and turn it from a tibble to a dataframe

tree_finite <- drop.tip(tree, tree$tip.label[-na.omit(match(species_summary_finite$species, tree$tip.label))]) #trim tree again

tree_finite$node.label[tree_finite$node.label == ""] <- which(tree_finite$node.label == "") #label unnamed nodes based on node number

row.names(species_summary_finite)<- species_summary_finite$species #makes species names the row names again for combining the dataframes
```

##Perform ANOVA between simple photoperiodism groups with all available regression lines
```{r}
simple_photoperiodism_vector2 <- species_summary_finite$simple_photoperiodism
year_effect_vector2 <- species_summary_finite$year_effect

aov_species_summary_finite <- phylANOVA(tree = tree_finite, x = simple_photoperiodism_vector2, y = year_effect_vector2, nsim = 9999, posthoc = TRUE)
```
## DOESN'T WORK Perform ANOVA between simple photoperiodism groups with all available regression lines BUT ALSO with weighting based on number of datapoints (ln(n_datapoints))
```{r}
#source("./R/phylANOVA2.R")

#weight_vector2 <- log(species_summary_finite$n)

#aov_species_summary_finite_weighted <- phylANOVA2(tree = tree_finite, x = simple_photoperiodism_vector2, y = year_effect_vector2, z =  weight_vector2 ,nsim = 9999, posthoc = TRUE)
```

#Perform comparison ANOVA without phylo information
```{r}
aov_species_summary_NOPHYLO <- aov(year_effect ~ simple_photoperiodism, data = species_summary_finite)
```

#Compare the anovas
```{r}
aov_species_summary_confident
aov_species_summary_finite
aov_species_summary_finite_weighted
summary(aov_species_summary_NOPHYLO)
```

#the difference between groups is (barely) no longer significant.

I'm not 100% happy with yet though.

There was no way of weighting in phylANOVA (it uses anova() which doesn't have weighting options instead of aov() which does) so that records we were more confident in were more represented. I'm trying to go into the package code and between the base uncorrected anova and matrix sections, add the weighting in myself to the function. Working on that currently.


#dplyr for general manipulation
#ape for phylogenetic manipulation
#phylanova (phytools) for anova with phylogenetic


#exclude trends with less than three years

#Next iteration
- Remove all values that span less than 3 years
- Rerun both no-phylo and phylo experiments

for each species, count the number of years covered by records and then append it to all the datapoints
```{r}
df <- df %>% group_by(species) %>% mutate(years_covered_per_sp = n_distinct(year))
```

Filter out the records (which also happen to be entire species) where there are less than three years of data.
```{r}
df <- df[df$years_covered_per_sp > 2, ]
```

Rerun species_summary 
```{r}
species_summary2 <- df %>% 
  group_by(species) %>% #for each species repeat analysis
  do({ summ <- summary(lm(doy ~ year + lat, .)) #make linear model and take a summary
       summarize(.,intercept = summ[["coefficients"]][1], #take only the numbers we are interested in from each lm
                 intercept_p = summ[["coefficients"]][10], #ie what are the effects of each variable
                 year_effect = summ[["coefficients"]][2],  #and how certain we are of each (p-val)
                 year_p = summ[["coefficients"]][11],
                 lat_effect = summ[["coefficients"]][3],
                 lat_p = summ[["coefficients"]][12])}) %>% ungroup() #ungroup to put it all in one table

species_summary2$species <- gsub(" ", "_", species_summary2$species)#change species name to fit phylo trees

pp2 <- pp %>% filter(order == "1")
pp2$species <- gsub(" ", "_", pp2$species)

species_summary2 <- left_join(species_summary2, pp2[, c(1, 7, 9)], by = "species") #put the photoperiod info back in
```

#there's no need to isolate finite now because all results are finite now yay
```{r}
tree2 <- drop.tip(tree, tree$tip.label[-na.omit(match(species_summary2$species, tree$tip.label))]) #trim tree again

tree2$node.label[tree2$node.label == ""] <- which(tree2$node.label == "") #label unnamed nodes based on node number

species_summary2 <- species_summary2[species_summary2$species %in% tree2$tip.label,] #filter dataframe based on tree

species_summary2 <- species_summary2 %>% arrange(match(species_summary2$species, tree2$tip.label)) #reorder dataframe to match tree

species_summary2[55, 8] <- "ld" #not sure what happened

simple_photoperiodism_vector3 <- species_summary2$simple_photoperiodism
year_effect_vector3 <- species_summary2$year_effect 
#make vectors for phylo anova

aov_species_summary_finite2 <- phylANOVA(tree = tree2, x = simple_photoperiodism_vector3, y = year_effect_vector3, nsim = 9999, posthoc = TRUE)

aov_species_summary_NOPHYLO2 <- aov(year_effect ~ simple_photoperiodism, data = species_summary2)


#post-hoc pairwise t tests

```

```{r}
summary(aov_species_summary_NOPHYLO2)

```
```{r}
aov_species_summary_finite2
```

#the difference between groups is  no longer significant.
