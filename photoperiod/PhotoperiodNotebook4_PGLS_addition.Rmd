---
title: "PhotoperiodNotebook4_PGLS_addition"
output: html_notebook
---

Code to test whether photoperiod sensitivity is affecting when plants flower over time, but now taking into account phylogenetic relatedness!


##Load Packages
```{r}
library(ape)#read.tree(), ditomulti() and manipulating phylogenetic trees
library(geiger) #mphylo comparative data and macroevo models
library(lme4) #linear models
library(phytools) #pglsModel()

library(tidyverse)
```


##Load photoperiod and flowering time data 
and make sure species names will match the phylogenetic tree
```{r}
pp <- read.csv("./Data/appendix1.csv") #read in photoperiod data

pp <- pp %>% 
  group_by(species)%>% #for each species
  slice(which.min(order))  #find most accurate photoperiod record

ft <- read.csv("./data/appendix2.csv") #read completed flowering time data

df <- left_join(ft, pp, by = "species") #join the two datasets
rm(pp)
rm(ft)

df$species <- gsub(" ", "_", df$species)
```

##Load tree 
from smith and brown (2018) (https://doi.org/10.1002/ajb2.1019)
```{r}
tree <- read.tree("./data/ALLMB.txt")
```

##Trim tree based on species in df
```{r}
species_list <- unique(df$species) #list of species in df

tree <- drop.tip(tree, tree$tip.label[-na.omit(match(species_list, tree$tip.label))])
```

##Transform dataframe to match tree
```{r}
df <- df %>% arrange(match(df$species, tree$tip.label)) #reorder df according to tree order

df <- as.data.frame(df) #turn tibble back to dataframe
```

##check that the names match
```{r}
name.check(tree, data.names = df)
```

#DOESN'T WORK1 
trying method adapted from https://lukejharmon.github.io/ilhabela/instruction/2015/07/03/PGLS/ 

```{r}
library(ape) #for vcvphylo
library(nlme) #for nlme
```

Make a covariance matrix
So this doesn't work because we have multiple datapoints of a single species
```{r}
phylo_matrix <- ape::vcv.phylo(tree, corr = T) #make a matrix of how related each species is to each other species for weighting
corr <- corPagel(value = 0.5, phy = tree, fixed = FALSE)
```

run new model
```{r}
lm_phylo <- gls(model = doy ~ simple_photoperiodism*year-1 + lat:simple_photoperiodism, data = df, correlation = corPagel(value = 1, phy = tree, fixed = FALSE))

summary(lm_phylo)
```
https://www.researchgate.net/post/Lookin_for_R_package_capable_of_handling_phylogenetic_trees_random_effects_and_zero-inflation

#Doesn't work 2

```{r}
library(pez)
```


```{r}
df$species <- as.factor(df$species)

lm_final_phylo <- communityPGLMM(doy ~ year, data = df, family = "gaussian",
sp = as.factor(df$species), site = as.factor(df$lat),
REML = TRUE, verbose = FALSE)

lm_final <- lmer(doy ~ simple_photoperiodism*year-1 + (1|species) + lat:simple_photoperiodism, data = df) 


```

#Doesn't work 3 Trying MCMCglmm instead

https://stackoverflow.com/questions/51132259/phylogenetic-model-using-multiple-entries-for-each-species

fixed effects: doy ~ simple_photoperiodism*year-1
random effects: lat:simple_photoperiodism AND tree 
family: gaussian

```{r}
library(MCMCglmm) #bayesian phylogenetic glmm
library(caper) #creating a 'comparative dataset', ie, combining df and tree (but normally only works on one datapoint species)
```

```{r}

```


```{r}
lm_phylo <- MCMCglmm(doy ~ simple_photoperiodism*year-1, random = ~lat:simple_photoperiodism + ~taxon, data = df)
```

##make tree ultrametric and set phylo effect
```{r}
phylo.effect<-rbv(force.ultrametric(tree), 1, nodes="TIPS")

```

#Doesn't work 3
phylolm, duplicate rownames not allowed
```{r}
library(phylolm)

tree$node.label[tree$node.label == ""] <- which(tree$node.label == "")
row.names(df) <- df$species 

phyloglm(formula = doy~simple_photoperiodism*year + lat:simple_photoperiodism, data = df, phy = tree)
```


##rerun the original model for comparison
```{r}
lm_final <- lmer(doy ~ simple_photoperiodism*year-1 + (1|species) + lat:simple_photoperiodism, data = df) 
```

